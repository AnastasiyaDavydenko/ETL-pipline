# ETL-pipline

## Входные данные

Дана база данных в ClickHouse некоторого приложения "Лента новостей и мессенджер". База данных состоит из 2 таблиц feed_action и message_action: 

feed_action (лента новостей):
- user_id - id пользователя,
- time - время,
- action - действие (like or view),
- age (возраст пользователя),
- city - город,
- country - страна,
- exp_group - номер экспериментальной группы для AB и AA тестов,
- gender - гендер пользователя (0- мужчина, 1- женщина),
- os - операционная система (ios, android),
- post_id - номер поста,
- source - трафик (ads - реклама, organic).

message_action (мессенджер):
- user_id - id пользователя, который отправляет сообщение,
- reciever_id - id пользователя, который получает сообщение,
- time - время,
- source - трафик (ads - реклама, organic),
- gender - гендер пользователя (0- мужчина, 1- женщина),
- age (возраст пользователя),
- country - страна,
- city - город,
- os - операционная система (ios, android).

## Задание

Необходимо создать отчет, который будет ежедневно в 11:00 утра обрабатывать таблицы feed_action и message_action и считать метрики (количество лайков, просмотров, сколько пользователей отсылают и получают сообщения, скольким людям они пишут, сколько людей пишут пользователю) в разрезе по полу, возрасту и ос. Результат необходимо загрузить в таблицу в ClickHouse. Автоматизировать отчет с помощью Airflow.

## Решение
Создан DAG, который работает через Apache Airflow, и состоит из тасок:
- выгрузка данных из таблиц feed_actions и message_actions из ClickHouse с помощью SQL-запроса,
- объдинение результатов выгрузки из двух таблиц,
- преобразование данных и расчет по срезам (os, gender, age),
- ззагрузка результатов в ClickHouse.

## Cкриншот итоговой таблицы в ClickHouse:
![Screenshot_etl](https://user-images.githubusercontent.com/122218714/211315263-dbd86abb-c99e-43d6-8598-ba76ff17cbc3.png)
